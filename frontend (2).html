<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Technical Interviewer v2 - Multi-Agent</title>
    <!-- CodeMirror –¥–ª—è –ø–æ–¥—Å–≤–µ—Ç–∫–∏ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞ -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/theme/dracula.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/python/python.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        :root {
            --bg-primary: #1a1a2e;
            --bg-card: rgba(26, 32, 44, 0.95);
            --text-primary: #e2e8f0;
            --text-secondary: #a0aec0;
            --accent-purple: #6b46c1;
            --accent-pink: #9f7aea;
            --accent-blue: #4299e1;
            --accent-green: #48bb78;
            --accent-amber: #ed8936;
            --accent-red: #f56565;
            --border: rgba(74, 85, 104, 0.4);
            --hr-color: #805ad5;
            --tech-color: #3182ce;
            --dev-color: #38a169;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #1a1a2e 100%);
            color: var(--text-primary);
            min-height: 100vh;
        }
        
        .hidden { display: none !important; }
        
        .start-screen {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 20px;
        }
        
        .start-card {
            background: var(--bg-card);
            backdrop-filter: blur(20px);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 48px;
            max-width: 600px;
            width: 100%;
            text-align: center;
        }
        
        .logo { font-size: 64px; margin-bottom: 20px; }
        
        h1 {
            font-size: 2rem;
            margin-bottom: 8px;
            background: linear-gradient(135deg, var(--text-primary), var(--accent-purple));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .subtitle { color: var(--text-secondary); margin-bottom: 24px; }
        
        .agents-preview {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 32px;
            flex-wrap: wrap;
        }
        
        .agent-preview {
            text-align: center;
            padding: 16px;
            background: rgba(255,255,255,0.03);
            border-radius: 12px;
            min-width: 140px;
            border: 1px solid var(--border);
        }
        
        .agent-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            margin: 0 auto 10px;
        }
        
        .agent-preview.hr .agent-avatar { background: linear-gradient(135deg, var(--hr-color), #553c9a); }
        .agent-preview.tech .agent-avatar { background: linear-gradient(135deg, var(--tech-color), #2c5282); }
        .agent-preview.dev .agent-avatar { background: linear-gradient(135deg, var(--dev-color), #276749); }
        
        .agent-name { font-weight: 600; font-size: 0.95rem; }
        .agent-title { font-size: 0.8rem; color: var(--text-secondary); }
        
        .features {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 32px;
            text-align: left;
        }
        
        .feature {
            background: rgba(255,255,255,0.03);
            padding: 12px 16px;
            border-radius: 8px;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 12px;
            border: 1px solid var(--border);
        }
        
        .feature-icon { font-size: 20px; }
        
        .level-buttons {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
        }
        
        .level-btn {
            padding: 20px 16px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
        }
        
        .level-btn:hover { transform: translateY(-4px); box-shadow: 0 4px 12px rgba(0,0,0,0.3); }
        .level-btn.junior { background: linear-gradient(135deg, #38a169, #276749); }
        .level-btn.middle { background: linear-gradient(135deg, #ed8936, #c05621); }
        .level-btn.senior { background: linear-gradient(135deg, #e53e3e, #c53030); }
        
        .main-screen { min-height: 100vh; }
        
        .header {
            background: var(--bg-card);
            padding: 12px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border);
        }
        
        .header-left { display: flex; align-items: center; gap: 16px; }
        
        .current-agent {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 16px;
            background: rgba(255,255,255,0.05);
            border-radius: 10px;
            border: 1px solid var(--border);
        }
        
        .current-agent-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }
        
        .current-agent.hr .current-agent-avatar { background: var(--hr-color); }
        .current-agent.tech .current-agent-avatar { background: var(--tech-color); }
        .current-agent.dev .current-agent-avatar { background: var(--dev-color); }
        
        .header-stats { display: flex; gap: 12px; }
        
        .stat {
            background: rgba(255,255,255,0.05);
            padding: 8px 14px;
            border-radius: 8px;
            font-size: 0.85rem;
            border: 1px solid var(--border);
        }
        
        .phase-tabs {
            display: flex;
            gap: 8px;
            padding: 12px 24px;
            background: rgba(0,0,0,0.3);
            border-bottom: 1px solid var(--border);
        }
        
        .phase-tab {
            padding: 8px 16px;
            border-radius: 6px;
            background: rgba(255,255,255,0.05);
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid var(--border);
            font-size: 0.9rem;
        }
        
        .phase-tab.active {
            background: var(--accent-purple);
            color: white;
            border-color: var(--accent-purple);
        }
        
        .main-layout {
            display: grid;
            grid-template-columns: 1fr 1.5fr;
            gap: 20px;
            padding: 20px;
            max-width: 1500px;
            margin: 0 auto;
        }
        
        .left-panel { display: flex; flex-direction: column; gap: 16px; }
        
        .card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            overflow: hidden;
        }
        
        .card-header {
            padding: 14px 18px;
            border-bottom: 1px solid var(--border);
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(0,0,0,0.2);
        }
        
        .card-body { padding: 18px; }
        
        .task-desc { color: var(--text-secondary); line-height: 1.6; margin-bottom: 16px; }
        
        .task-meta { display: flex; gap: 12px; margin-bottom: 16px; }
        
        .task-badge {
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 0.75rem;
            background: rgba(255,255,255,0.1);
            border: 1px solid var(--border);
        }
        
        .task-badge.difficulty-low { background: rgba(72,187,120,0.2); color: var(--accent-green); }
        .task-badge.difficulty-mid { background: rgba(237,137,54,0.2); color: var(--accent-amber); }
        .task-badge.difficulty-high { background: rgba(245,101,101,0.2); color: var(--accent-red); }
        
        .examples-box {
            background: rgba(0,0,0,0.4);
            border-radius: 8px;
            padding: 14px;
            font-family: monospace;
            font-size: 0.85rem;
            border: 1px solid var(--border);
        }
        
        .examples-label { font-size: 0.7rem; color: var(--text-secondary); margin-bottom: 8px; text-transform: uppercase; }
        .examples-code { color: var(--accent-green); white-space: pre-wrap; }
        
        .chat-card { display: flex; flex-direction: column; min-height: 300px; }
        
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 14px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-height: 250px;
        }
        
        .message {
            display: flex;
            gap: 10px;
            max-width: 85%;
            animation: fadeIn 0.3s;
        }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; } }
        
        .message.user { align-self: flex-end; flex-direction: row-reverse; }
        
        .msg-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            flex-shrink: 0;
        }
        
        .message.bot.hr .msg-avatar { background: var(--hr-color); }
        .message.bot.tech .msg-avatar { background: var(--tech-color); }
        .message.bot.dev .msg-avatar { background: var(--dev-color); }
        .message.user .msg-avatar { background: var(--accent-blue); }
        
        .msg-content {
            padding: 10px 14px;
            border-radius: 10px;
            line-height: 1.5;
        }
        
        .message.bot .msg-content { background: rgba(255,255,255,0.07); border: 1px solid var(--border); }
        .message.user .msg-content { background: var(--accent-blue); }
        
        .msg-name { font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 4px; }
        
        .chat-input-area {
            padding: 12px;
            background: rgba(0,0,0,0.3);
            display: flex;
            gap: 8px;
        }
        
        .chat-input {
            flex: 1;
            background: rgba(255,255,255,0.05);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 10px 14px;
            color: var(--text-primary);
            outline: none;
        }
        
        .chat-input:focus { border-color: var(--accent-purple); }
        
        .chat-btn {
            width: 40px;
            height: 40px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            transition: transform 0.2s;
        }
        
        .chat-btn:hover { transform: scale(1.05); }
        .chat-btn.send { background: var(--accent-blue); }
        .chat-btn.hint { background: var(--accent-amber); }
        
        .editor-card { display: flex; flex-direction: column; height: calc(100vh - 200px); min-height: 500px; }
        
        .editor-header {
            background: #0d1117;
            padding: 10px 14px;
            display: flex;
            align-items: center;
            gap: 12px;
            border-bottom: 1px solid var(--border);
        }
        
        .editor-dots { display: flex; gap: 6px; }
        .editor-dots i { width: 12px; height: 12px; border-radius: 50%; display: block; }
        .editor-dots i:nth-child(1) { background: #e53e3e; }
        .editor-dots i:nth-child(2) { background: #ed8936; }
        .editor-dots i:nth-child(3) { background: #38a169; }
        
        .editor-file { color: var(--text-secondary); font-size: 0.85rem; flex: 1; }
        
        .run-btn {
            background: linear-gradient(135deg, var(--accent-green), #276749);
            color: white;
            border: none;
            padding: 8px 20px;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
        }
        
        .code-editor {
            flex: 1;
            width: 100%;
            background: #0d1117;
            border: none;
            padding: 16px;
            color: #7ee787;
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 14px;
            line-height: 1.6;
            resize: none;
            outline: none;
            display: none; /* –°–∫—Ä—ã–≤–∞–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π textarea */
        }
        
        /* CodeMirror —Å—Ç–∏–ª–∏ */
        .CodeMirror {
            flex: 1;
            height: auto !important;
            min-height: 300px;
            font-family: 'Monaco', 'Consolas', 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.6;
            background: #0d1117 !important;
            border-radius: 0 0 10px 10px;
        }
        
        .CodeMirror-gutters {
            background: #161b22 !important;
            border-right: 1px solid #30363d !important;
        }
        
        .CodeMirror-linenumber {
            color: #6e7681 !important;
        }
        
        .cm-s-dracula .CodeMirror-cursor {
            border-left: 2px solid #50fa7b !important;
        }
        
        .cm-s-dracula .cm-keyword { color: #ff79c6 !important; }
        .cm-s-dracula .cm-def { color: #50fa7b !important; }
        .cm-s-dracula .cm-variable { color: #f8f8f2 !important; }
        .cm-s-dracula .cm-string { color: #f1fa8c !important; }
        .cm-s-dracula .cm-number { color: #bd93f9 !important; }
        .cm-s-dracula .cm-comment { color: #6272a4 !important; }
        .cm-s-dracula .cm-builtin { color: #8be9fd !important; }
        .cm-s-dracula .cm-operator { color: #ff79c6 !important; }
        
        .results-section { border-top: 1px solid var(--border); background: rgba(0,0,0,0.4); }
        .results-header { padding: 10px 14px; color: var(--text-secondary); font-size: 0.85rem; }
        
        .results-list {
            padding: 12px;
            max-height: 150px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .test-result {
            padding: 10px 14px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .test-result.pass { background: rgba(72,187,120,0.1); border: 1px solid rgba(72,187,120,0.3); }
        .test-result.fail { background: rgba(245,101,101,0.1); border: 1px solid rgba(245,101,101,0.3); }
        
        .theory-answer {
            width: 100%;
            min-height: 150px;
            background: rgba(0,0,0,0.4);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 14px;
            color: var(--text-primary);
            font-size: 0.95rem;
            line-height: 1.6;
            resize: vertical;
            outline: none;
        }
        
        .submit-theory-btn {
            margin-top: 12px;
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, var(--accent-purple), #553c9a);
            border: none;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            cursor: pointer;
        }
        
        .agent-switcher {
            display: flex;
            gap: 8px;
            padding: 12px;
            background: rgba(0,0,0,0.3);
            border-top: 1px solid var(--border);
        }
        
        .agent-switch-btn {
            flex: 1;
            padding: 10px;
            border: 1px solid var(--border);
            border-radius: 6px;
            cursor: default;
            font-size: 0.85rem;
            background: rgba(255,255,255,0.05);
            color: var(--text-secondary);
            transition: all 0.2s;
        }
        
        .agent-switch-btn.active { color: white; border-color: transparent; }
        .agent-switch-btn.hr.active { background: var(--hr-color); }
        .agent-switch-btn.tech.active { background: var(--tech-color); }
        .agent-switch-btn.dev.active { background: var(--dev-color); }
        
        .report-screen {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 20px;
        }
        
        .report-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 40px;
            max-width: 700px;
            width: 100%;
        }
        
        .report-header { text-align: center; margin-bottom: 32px; }
        .report-header h2 { font-size: 1.8rem; margin-bottom: 8px; }
        
        .final-decision {
            font-size: 1.4rem;
            font-weight: 700;
            padding: 16px;
            border-radius: 10px;
            margin-bottom: 24px;
            text-align: center;
        }
        
        .final-decision.hire { background: rgba(72,187,120,0.15); color: var(--accent-green); }
        .final-decision.maybe { background: rgba(237,137,54,0.15); color: var(--accent-amber); }
        .final-decision.no-hire { background: rgba(245,101,101,0.15); color: var(--accent-red); }
        
        .score-display { text-align: center; margin-bottom: 24px; }
        .score-big { font-size: 3rem; font-weight: 700; }
        .score-label { color: var(--text-secondary); }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-bottom: 24px;
        }
        
        .stat-box {
            background: rgba(255,255,255,0.03);
            padding: 16px;
            border-radius: 10px;
            text-align: center;
            border: 1px solid var(--border);
        }
        
        .stat-value { font-size: 1.4rem; font-weight: 700; }
        .stat-label { font-size: 0.8rem; color: var(--text-secondary); }
        
        .agent-feedbacks { margin-bottom: 24px; }
        .agent-feedbacks h3 { margin-bottom: 16px; font-size: 1.1rem; }
        
        .feedback-item {
            background: rgba(255,255,255,0.03);
            padding: 16px;
            border-radius: 10px;
            margin-bottom: 12px;
            border-left: 4px solid;
        }
        
        .feedback-item.hr { border-color: var(--hr-color); }
        .feedback-item.tech { border-color: var(--tech-color); }
        .feedback-item.dev { border-color: var(--dev-color); }
        
        .feedback-header { display: flex; justify-content: space-between; margin-bottom: 8px; }
        .feedback-name { font-weight: 600; }
        .feedback-text { color: var(--text-secondary); line-height: 1.5; font-size: 0.95rem; }
        
        .penalties-section { margin-bottom: 24px; }
        .penalties-section h3 { margin-bottom: 12px; font-size: 1rem; color: var(--accent-red); }
        
        .penalty-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 12px;
            background: rgba(245,101,101,0.1);
            border-radius: 6px;
            margin-bottom: 6px;
            font-size: 0.9rem;
        }
        
        .restart-btn {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, var(--accent-purple), #553c9a);
            border: none;
            border-radius: 10px;
            color: white;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
        }
        
        .finish-btn {
            margin-left: auto;
            padding: 10px 24px;
            background: linear-gradient(135deg, var(--accent-purple), #553c9a);
            border: none;
            border-radius: 6px;
            color: white;
            font-weight: 600;
            cursor: pointer;
        }
        
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .modal-content {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 32px;
            max-width: 400px;
            width: 90%;
            text-align: center;
        }
        
        .modal-icon { font-size: 48px; margin-bottom: 16px; }
        .modal-title { font-size: 1.3rem; font-weight: 600; margin-bottom: 12px; }
        .modal-text { color: var(--text-secondary); margin-bottom: 24px; line-height: 1.5; }
        
        .modal-btn {
            padding: 12px 32px;
            background: linear-gradient(135deg, var(--accent-purple), #553c9a);
            border: none;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            cursor: pointer;
            margin: 0 8px;
        }
        
        .modal-btn.secondary {
            background: rgba(255,255,255,0.1);
            border: 1px solid var(--border);
        }
        
        /* –ê–Ω—Ç–∏—á–∏—Ç –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ */
        .anticheat-warning {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(245, 101, 101, 0.95);
            color: white;
            padding: 16px 24px;
            border-radius: 10px;
            z-index: 2000;
            animation: slideIn 0.3s;
            max-width: 350px;
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .anticheat-warning h4 { margin-bottom: 8px; }
        .anticheat-warning p { font-size: 0.9rem; opacity: 0.9; }
        
        @media (max-width: 900px) {
            .main-layout { grid-template-columns: 1fr; }
            .agents-preview { flex-direction: column; align-items: center; }
            .level-buttons { grid-template-columns: 1fr; }
            .stats-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div id="app"></div>
    <div id="anticheat-warnings"></div>
    
    <script>
        const API_URL = 'http://localhost:8000';
        
        // –ò–ú–ï–ù–ê –ê–ì–ï–ù–¢–û–í
        const AGENT_NAMES = {
            hr_manager: { name: '–ù–∞—Ç–∞–ª—å—è', title: 'HR Manager', emoji: 'üë©‚Äçüíº' },
            tech_lead: { name: '–ò–≤–∞–Ω', title: 'Tech Lead', emoji: 'üë®‚Äçüíª' },
            senior_dev: { name: '–ê–ª–µ–∫—Å–µ–π', title: 'Senior Dev', emoji: 'üßë‚Äçüíª' }
        };
        
        const PHASE_AGENT_MAP = {
            intro: 'hr_manager',
            theory: 'tech_lead',
            coding: 'senior_dev',
            review: 'senior_dev'
        };
        
        // ============================================
        // –ê–ù–¢–ò–ß–ò–¢ –°–ò–°–¢–ï–ú–ê
        // ============================================
        const antiCheat = {
            enabled: true,
            violations: [],
            typingData: {
                lastKeyTime: 0,
                charCount: 0,
                startTime: 0,
                intervals: []
            },
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∞–Ω—Ç–∏—á–∏—Ç–∞
            init() {
                this.blockPaste();
                this.monitorTypingSpeed();
                this.detectExtensions();
                this.blockContextMenu();
                console.log('üõ°Ô∏è AntiCheat —Å–∏—Å—Ç–µ–º–∞ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞');
            },
            
            // –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –≤—Å—Ç–∞–≤–∫–∏
            blockPaste() {
                document.addEventListener('paste', (e) => {
                    if (!this.enabled) return;
                    
                    const target = e.target;
                    if (target.classList.contains('code-editor') || 
                        target.classList.contains('chat-input') ||
                        target.classList.contains('theory-answer')) {
                        
                        e.preventDefault();
                        this.reportViolation('paste_detected', '–ü–æ–ø—ã—Ç–∫–∞ –≤—Å—Ç–∞–≤–∫–∏ —Ç–µ–∫—Å—Ç–∞');
                        this.showWarning('–í—Å—Ç–∞–≤–∫–∞ –∑–∞–ø—Ä–µ—â–µ–Ω–∞', '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–∞–±–∏—Ä–∞–π—Ç–µ —Ç–µ–∫—Å—Ç —Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ.');
                    }
                });
                
                // –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ Ctrl+V
                document.addEventListener('keydown', (e) => {
                    if (!this.enabled) return;
                    
                    if ((e.ctrlKey || e.metaKey) && e.key === 'v') {
                        const target = e.target;
                        if (target.classList.contains('code-editor') || 
                            target.classList.contains('chat-input') ||
                            target.classList.contains('theory-answer')) {
                            
                            e.preventDefault();
                            this.reportViolation('paste_detected', '–ü–æ–ø—ã—Ç–∫–∞ Ctrl+V');
                            this.showWarning('–í—Å—Ç–∞–≤–∫–∞ –∑–∞–ø—Ä–µ—â–µ–Ω–∞', '–ö–æ–º–±–∏–Ω–∞—Ü–∏—è Ctrl+V –æ—Ç–∫–ª—é—á–µ–Ω–∞.');
                        }
                    }
                });
            },
            
            // –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Å–∫–æ—Ä–æ—Å—Ç–∏ –ø–µ—á–∞—Ç–∏
            monitorTypingSpeed() {
                document.addEventListener('keydown', (e) => {
                    if (!this.enabled) return;
                    
                    const target = e.target;
                    if (!target.classList.contains('code-editor') && 
                        !target.classList.contains('chat-input') &&
                        !target.classList.contains('theory-answer')) {
                        return;
                    }
                    
                    // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º —Å–ª—É–∂–µ–±–Ω—ã–µ –∫–ª–∞–≤–∏—à–∏
                    if (e.key.length > 1 && !['Backspace', 'Delete'].includes(e.key)) return;
                    
                    const now = Date.now();
                    
                    if (this.typingData.lastKeyTime === 0) {
                        this.typingData.startTime = now;
                    } else {
                        const interval = now - this.typingData.lastKeyTime;
                        this.typingData.intervals.push(interval);
                        
                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ä–µ–¥–Ω—é—é —Å–∫–æ—Ä–æ—Å—Ç—å –∫–∞–∂–¥—ã–µ 20 —Å–∏–º–≤–æ–ª–æ–≤
                        if (this.typingData.intervals.length >= 20) {
                            const avgInterval = this.typingData.intervals.reduce((a, b) => a + b, 0) / this.typingData.intervals.length;
                            
                            // –ï—Å–ª–∏ —Å—Ä–µ–¥–Ω–∏–π –∏–Ω—Ç–µ—Ä–≤–∞–ª –º–µ–Ω—å—à–µ 30–º—Å - —ç—Ç–æ –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω–æ –±—ã—Å—Ç—Ä–æ (>2000 —Å–∏–º–≤–æ–ª–æ–≤ –≤ –º–∏–Ω—É—Ç—É)
                            if (avgInterval < 30) {
                                this.reportViolation('fast_typing_detected', `–ü–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω–æ –±—ã—Å—Ç—Ä—ã–π –≤–≤–æ–¥: ${Math.round(60000/avgInterval)} —Å–∏–º–≤–æ–ª–æ–≤/–º–∏–Ω`);
                                this.showWarning('–ü–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å', '–û–±–Ω–∞—Ä—É–∂–µ–Ω–∞ —Å–ª–∏—à–∫–æ–º –≤—ã—Å–æ–∫–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å –ø–µ—á–∞—Ç–∏.');
                            }
                            
                            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–π –ø—Ä–æ–≤–µ—Ä–∫–∏
                            this.typingData.intervals = [];
                        }
                    }
                    
                    this.typingData.lastKeyTime = now;
                    this.typingData.charCount++;
                });
            },
            
            // –ü–æ–ø—ã—Ç–∫–∞ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è
            detectExtensions() {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏–∑–≤–µ—Å—Ç–Ω—ã–µ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏
                const suspiciousGlobals = [
                    'webdriver',
                    '__webdriver_script_fn',
                    '__driver_evaluate',
                    '__webdriver_evaluate',
                    '__selenium_evaluate',
                    '__fxdriver_evaluate',
                    '__driver_unwrapped',
                    '__webdriver_unwrapped',
                    '__selenium_unwrapped',
                    '__fxdriver_unwrapped',
                    '_Selenium_IDE_Recorder',
                    '_selenium',
                    'calledSelenium',
                    '$cdc_asdjflasutopfhvcZLmcfl_',
                    '$chrome_asyncScriptInfo',
                    '__nightmare',
                    '__puppeteer_evaluation_script__'
                ];
                
                for (const global of suspiciousGlobals) {
                    if (window[global] !== undefined || document[global] !== undefined) {
                        this.reportViolation('extension_detected', `–û–±–Ω–∞—Ä—É–∂–µ–Ω–æ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä—É—é—â–µ–µ –ü–û: ${global}`);
                        this.showWarning('–û–±–Ω–∞—Ä—É–∂–µ–Ω–æ –ü–û', '–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä—É—é—â–µ–≥–æ –ü–û –∑–∞–ø—Ä–µ—â–µ–Ω–æ.');
                        break;
                    }
                }
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º navigator.webdriver
                if (navigator.webdriver) {
                    this.reportViolation('extension_detected', 'navigator.webdriver = true');
                    this.showWarning('–ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è', '–û–±–Ω–∞—Ä—É–∂–µ–Ω —Ä–µ–∂–∏–º –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏ –±—Ä–∞—É–∑–µ—Ä–∞.');
                }
            },
            
            // –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–≥–æ –º–µ–Ω—é (–ø—Ä–∞–≤–∞—è –∫–Ω–æ–ø–∫–∞)
            blockContextMenu() {
                document.addEventListener('contextmenu', (e) => {
                    if (!this.enabled) return;
                    
                    const target = e.target;
                    if (target.classList.contains('code-editor') || 
                        target.classList.contains('chat-input') ||
                        target.classList.contains('theory-answer')) {
                        
                        e.preventDefault();
                        this.showWarning('–î–µ–π—Å—Ç–≤–∏–µ –∑–∞–ø—Ä–µ—â–µ–Ω–æ', '–ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é –æ—Ç–∫–ª—é—á–µ–Ω–æ.');
                    }
                });
            },
            
            // –û—Ç–ø—Ä–∞–≤–∫–∞ –Ω–∞—Ä—É—à–µ–Ω–∏—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä
            async reportViolation(type, reason) {
                this.violations.push({ type, reason, timestamp: Date.now() });
                
                try {
                    await fetch(`${API_URL}/api/anticheat-violation`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ type, reason })
                    });
                } catch (e) {
                    console.log('–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–∞—Ä—É—à–µ–Ω–∏–µ:', e);
                }
            },
            
            // –ü–æ–∫–∞–∑–∞—Ç—å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ
            showWarning(title, message) {
                const container = document.getElementById('anticheat-warnings');
                const warning = document.createElement('div');
                warning.className = 'anticheat-warning';
                warning.innerHTML = `<h4>‚ö†Ô∏è ${title}</h4><p>${message}</p>`;
                container.appendChild(warning);
                
                setTimeout(() => {
                    warning.style.animation = 'slideIn 0.3s reverse';
                    setTimeout(() => warning.remove(), 300);
                }, 4000);
            },
            
            // –°–±—Ä–æ—Å –¥–∞–Ω–Ω—ã—Ö –ø–µ—á–∞—Ç–∏
            resetTypingData() {
                this.typingData = {
                    lastKeyTime: 0,
                    charCount: 0,
                    startTime: 0,
                    intervals: []
                };
            },
            
            // –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –Ω–∞–∂–∞—Ç–∏—è –∫–ª–∞–≤–∏—à (–¥–ª—è CodeMirror)
            trackKeystroke(source) {
                if (!this.enabled) return;
                
                const now = Date.now();
                
                if (this.typingData.lastKeyTime === 0) {
                    this.typingData.startTime = now;
                } else {
                    const interval = now - this.typingData.lastKeyTime;
                    this.typingData.intervals.push(interval);
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ä–µ–¥–Ω—é—é —Å–∫–æ—Ä–æ—Å—Ç—å –∫–∞–∂–¥—ã–µ 20 —Å–∏–º–≤–æ–ª–æ–≤
                    if (this.typingData.intervals.length >= 20) {
                        const avgInterval = this.typingData.intervals.reduce((a, b) => a + b, 0) / this.typingData.intervals.length;
                        
                        // –ï—Å–ª–∏ —Å—Ä–µ–¥–Ω–∏–π –∏–Ω—Ç–µ—Ä–≤–∞–ª –º–µ–Ω—å—à–µ 30–º—Å - —ç—Ç–æ –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω–æ –±—ã—Å—Ç—Ä–æ
                        if (avgInterval < 30) {
                            this.reportViolation('fast_typing_detected', `–ü–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω–æ –±—ã—Å—Ç—Ä—ã–π –≤–≤–æ–¥ –≤ ${source}: ${Math.round(60000/avgInterval)} —Å–∏–º–≤–æ–ª–æ–≤/–º–∏–Ω`);
                            this.showWarning('–ü–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å', '–û–±–Ω–∞—Ä—É–∂–µ–Ω–∞ —Å–ª–∏—à–∫–æ–º –≤—ã—Å–æ–∫–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å –ø–µ—á–∞—Ç–∏.');
                        }
                        
                        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–π –ø—Ä–æ–≤–µ—Ä–∫–∏
                        this.typingData.intervals = [];
                    }
                }
                
                this.typingData.lastKeyTime = now;
                this.typingData.charCount++;
            }
        };
        
        // STATE 
        let state = {
            screen: 'start',
            level: null,
            phase: 'intro',
            currentAgent: null,
            currentTask: null,
            currentTheory: null,
            taskNum: 0,
            taskTotal: 0,
            theoryNum: 0,
            theoryTotal: 0,
            messages: [],
            testResults: [],
            report: null,
            loading: false,
            codeValue: '',
            theoryAnswer: '',
            introMessageCount: 0,
            showIntroModal: false
        };
        
        function getVisualAgent() {
            const agentRole = PHASE_AGENT_MAP[state.phase] || 'hr_manager';
            return { role: agentRole, ...AGENT_NAMES[agentRole] };
        }
        
        async function api(endpoint, method = 'GET', body = null) {
            const options = {
                method,
                headers: { 'Content-Type': 'application/json' }
            };
            if (body) options.body = JSON.stringify(body);
            
            try {
                const res = await fetch(`${API_URL}${endpoint}`, options);
                return await res.json();
            } catch (e) {
                console.error('API Error:', e);
                return { success: false, error: e.message };
            }
        }
        
        async function startInterview(level) {
            state.loading = true;
            render();
            
            const res = await api('/api/start', 'POST', { level });
            
            if (res.success) {
                state.level = level;
                state.screen = 'main';
                state.currentAgent = res.agent;
                state.taskTotal = res.total_coding_tasks;
                state.theoryTotal = res.total_theory_questions;
                
                const visualAgent = getVisualAgent();
                state.messages = [{ type: 'bot', agent: visualAgent, text: res.greeting }];
                state.phase = 'intro';
                state.introMessageCount = 0;
                
                // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –∞–Ω—Ç–∏—á–∏—Ç
                antiCheat.init();
                
                await loadTheory();
            }
            
            state.loading = false;
            render();
        }
        
        async function loadTask() {
            const res = await api('/api/task');
            if (res.success) {
                state.currentTask = res.task;
                state.taskNum = res.current;
                state.taskTotal = res.total;
                state.testResults = [];
                antiCheat.resetTypingData();
                
                // –û–±–Ω–æ–≤–ª—è–µ–º CodeMirror
                updateCodeEditor(res.task.starter_code || '');
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –µ—Å–ª–∏ –∑–∞–¥–∞—á–∞ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–∞
                if (res.task.is_generated) {
                    console.log('üìù –ó–∞–¥–∞—á–∞ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–∞ LLM –Ω–∞ –æ—Å–Ω–æ–≤–µ:', res.task.based_on);
                }
            }
            return res;
        }
        
        async function loadTheory() {
            const res = await api('/api/theory');
            if (res.success) {
                state.currentTheory = res.question;
                state.theoryNum = res.current;
                state.theoryTotal = res.total;
                state.theoryAnswer = '';
                antiCheat.resetTypingData();
            }
            return res;
        }
        
        async function submitCode() {
            if (!state.currentTask) return;
            
            state.loading = true;
            render();
            
            const res = await api('/api/submit-code', 'POST', {
                code: state.codeValue,
                task_id: state.currentTask.id
            });
            
            if (res.success) {
                state.testResults = res.results;
                const visualAgent = getVisualAgent();
                addMessage('bot', res.feedback, visualAgent);
                
                if (res.coding_finished) {
                    addMessage('bot', 'üéâ –í—ã –∑–∞–≤–µ—Ä—à–∏–ª–∏ –≤—Å–µ –∑–∞–¥–∞—á–∏ –Ω–∞ –∫–æ–¥! –ú–æ–∂–µ—Ç–µ –∑–∞–≤–µ—Ä—à–∏—Ç—å –∏–Ω—Ç–µ—Ä–≤—å—é.', visualAgent);
                } else if (res.next_task) {
                    setTimeout(async () => {
                        await loadTask();
                        render();
                    }, 1500);
                }
            }
            
            state.loading = false;
            render();
        }
        
        async function submitTheory() {
            if (!state.currentTheory || !state.theoryAnswer.trim()) return;
            
            state.loading = true;
            render();
            
            const res = await api('/api/submit-theory', 'POST', {
                answer: state.theoryAnswer,
                question_id: state.currentTheory.id
            });
            
            if (res.success) {
                const visualAgent = getVisualAgent();
                addMessage('user', state.theoryAnswer);
                addMessage('bot', `–û—Ü–µ–Ω–∫–∞: ${res.score}%. ${res.feedback}`, visualAgent);
                
                if (res.theory_finished) {
                    state.phase = 'coding';
                    const codingAgent = getVisualAgent();
                    addMessage('bot', 'üìù –¢–µ–æ—Ä–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞. –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ –∑–∞–¥–∞—á–∞–º –Ω–∞ –∫–æ–¥!', codingAgent);
                    await loadTask();
                } else {
                    setTimeout(async () => {
                        await loadTheory();
                        render();
                    }, 1000);
                }
            }
            
            state.loading = false;
            render();
        }
        
        async function sendChat() {
            const input = document.getElementById('chatInput');
            const msg = input.value.trim();
            if (!msg) return;
            
            input.value = '';
            addMessage('user', msg);
            render();
            
            // –°–Ω–∞—á–∞–ª–∞ –ø–æ–ª—É—á–∞–µ–º –æ—Ç–≤–µ—Ç –æ—Ç API
            const res = await api('/api/chat', 'POST', { message: msg });
            
            if (res.success && res.response) {
                const visualAgent = getVisualAgent();
                addMessage('bot', res.response, visualAgent);
            }
            
            // –¢–æ–ª—å–∫–æ –ü–û–°–õ–ï –æ—Ç–≤–µ—Ç–∞ —Å—á–∏—Ç–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è –∑–Ω–∞–∫–æ–º—Å—Ç–≤–∞
            if (state.phase === 'intro') {
                state.introMessageCount++;
                if (state.introMessageCount === 3) {
                    state.showIntroModal = true;
                }
            }
            
            antiCheat.resetTypingData();
            render();
        }
        
        async function getHint() {
            const res = await api('/api/hint', 'POST');
            if (res.success) {
                const visualAgent = getVisualAgent();
                addMessage('bot', res.hint, visualAgent);
                if (res.penalty_applied) {
                    addMessage('bot', '‚ö†Ô∏è –®—Ç—Ä–∞—Ñ –∑–∞ –ø–æ–¥—Å–∫–∞–∑–∫—É: -3 –±–∞–ª–ª–∞', visualAgent);
                }
            }
            render();
        }
        
        async function finishInterview() {
            state.loading = true;
            render();
            
            const res = await api('/api/finish', 'POST');
            
            if (res.success) {
                state.report = res.report;
                state.screen = 'report';
            }
            
            state.loading = false;
            render();
        }
        
        function addMessage(type, text, agent = null) {
            state.messages.push({ type, text, agent: agent || getVisualAgent() });
        }
        
        function changePhase(phase) {
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º CodeMirror –µ—Å–ª–∏ –≤—ã—Ö–æ–¥–∏–º –∏–∑ coding
            if (state.phase === 'coding' && phase !== 'coding' && cmEditor) {
                cmEditor.toTextArea();
                cmEditor = null;
            }
            
            state.phase = phase;
            if (phase === 'coding') loadTask();
            else if (phase === 'theory') loadTheory();
            render();
        }
        
        function closeModal() {
            state.showIntroModal = false;
            render();
        }
        
        function goToTheory() {
            state.showIntroModal = false;
            changePhase('theory');
        }
        
        function restart() {
            // –£–Ω–∏—á—Ç–æ–∂–∞–µ–º CodeMirror –µ—Å–ª–∏ –µ—Å—Ç—å
            if (cmEditor) {
                cmEditor.toTextArea();
                cmEditor = null;
            }
            
            state = {
                screen: 'start', level: null, phase: 'intro', currentAgent: null,
                currentTask: null, currentTheory: null, taskNum: 0, taskTotal: 0,
                theoryNum: 0, theoryTotal: 0, messages: [], testResults: [],
                report: null, loading: false, codeValue: '', theoryAnswer: '',
                introMessageCount: 0, showIntroModal: false
            };
            antiCheat.violations = [];
            render();
        }
        
        function render() {
            const app = document.getElementById('app');
            
            if (state.screen === 'start') {
                app.innerHTML = renderStartScreen();
            } else if (state.screen === 'main') {
                app.innerHTML = renderMainScreen();
            } else if (state.screen === 'report') {
                app.innerHTML = renderReportScreen();
            }
            
            if (state.showIntroModal) {
                app.innerHTML += renderIntroModal();
            }
            
            setupEventListeners();
        }
        
        function renderIntroModal() {
            return `
                <div class="modal-overlay" onclick="closeModal()">
                    <div class="modal-content" onclick="event.stopPropagation()">
                        <div class="modal-icon">‚ú®</div>
                        <div class="modal-title">–û—Ç–ª–∏—á–Ω–æ!</div>
                        <div class="modal-text">–í—ã –º–æ–∂–µ—Ç–µ –ø–µ—Ä–µ–π—Ç–∏ –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —ç—Ç–∞–ø—É ‚Äî —Ç–µ–æ—Ä–µ—Ç–∏—á–µ—Å–∫–∏–º –≤–æ–ø—Ä–æ—Å–∞–º, –∏–ª–∏ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å –∑–Ω–∞–∫–æ–º—Å—Ç–≤–æ.</div>
                        <div>
                            <button class="modal-btn" onclick="goToTheory()">–ü–µ—Ä–µ–π—Ç–∏ –∫ —Ç–µ–æ—Ä–∏–∏</button>
                            <button class="modal-btn secondary" onclick="closeModal()">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å</button>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function renderStartScreen() {
            return `
                <div class="start-screen">
                    <div class="start-card">
                        <div class="logo">ü§ñ</div>
                        <h1>AI Technical Interviewer v2</h1>
                        <p class="subtitle">–ú—É–ª—å—Ç–∏–∞–≥–µ–Ω—Ç–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –∏–Ω—Ç–µ—Ä–≤—å—é</p>
                        
                        <div class="agents-preview">
                            <div class="agent-preview hr">
                                <div class="agent-avatar">üë©‚Äçüíº</div>
                                <div class="agent-name">–ù–∞—Ç–∞–ª—å—è</div>
                                <div class="agent-title">HR Manager</div>
                            </div>
                            <div class="agent-preview tech">
                                <div class="agent-avatar">üë®‚Äçüíª</div>
                                <div class="agent-name">–ò–≤–∞–Ω</div>
                                <div class="agent-title">Tech Lead</div>
                            </div>
                            <div class="agent-preview dev">
                                <div class="agent-avatar">üßë‚Äçüíª</div>
                                <div class="agent-name">–ê–ª–µ–∫—Å–µ–π</div>
                                <div class="agent-title">Senior Dev</div>
                            </div>
                        </div>
                        
                        <div class="features">
                            <div class="feature"><span class="feature-icon">üìö</span> –¢–µ–æ—Ä–µ—Ç–∏—á–µ—Å–∫–∏–µ –≤–æ–ø—Ä–æ—Å—ã + –∫–æ–¥</div>
                            <div class="feature"><span class="feature-icon">üéØ</span> –ê–¥–∞–ø—Ç–∏–≤–Ω–∞—è —Å–ª–æ–∂–Ω–æ—Å—Ç—å</div>
                            <div class="feature"><span class="feature-icon">üõ°Ô∏è</span> –ê–Ω—Ç–∏—á–∏—Ç —Å–∏—Å—Ç–µ–º–∞</div>
                            <div class="feature"><span class="feature-icon">ü§ù</span> –°–æ–≤–µ—â–∞–Ω–∏–µ –∞–≥–µ–Ω—Ç–æ–≤</div>
                        </div>
                        
                        <div class="level-buttons">
                            <button class="level-btn junior" onclick="startInterview('junior')">üå± Junior</button>
                            <button class="level-btn middle" onclick="startInterview('middle')">üåø Middle</button>
                            <button class="level-btn senior" onclick="startInterview('senior')">üå≥ Senior</button>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function renderMainScreen() {
            const visualAgent = getVisualAgent();
            const agentClass = visualAgent.role === 'hr_manager' ? 'hr' : visualAgent.role === 'tech_lead' ? 'tech' : 'dev';
            
            return `
                <div class="main-screen">
                    <header class="header">
                        <div class="header-left">
                            <div class="current-agent ${agentClass}">
                                <div class="current-agent-avatar">${visualAgent.emoji}</div>
                                <div>
                                    <div style="font-weight:600">${visualAgent.name}</div>
                                    <div style="font-size:0.75rem;color:var(--text-secondary)">${visualAgent.title}</div>
                                </div>
                            </div>
                        </div>
                        <div class="header-stats">
                            <span class="stat">üìù –¢–µ–æ—Ä–∏—è: ${state.theoryNum}/${state.theoryTotal}</span>
                            <span class="stat">üíª –ö–æ–¥: ${state.taskNum}/${state.taskTotal}</span>
                            <span class="stat">${state.level?.toUpperCase()}</span>
                        </div>
                    </header>
                    
                    <div class="phase-tabs">
                        <button class="phase-tab ${state.phase === 'intro' ? 'active' : ''}" onclick="changePhase('intro')">–ó–Ω–∞–∫–æ–º—Å—Ç–≤–æ</button>
                        <button class="phase-tab ${state.phase === 'theory' ? 'active' : ''}" onclick="changePhase('theory')">–¢–µ–æ—Ä–∏—è</button>
                        <button class="phase-tab ${state.phase === 'coding' ? 'active' : ''}" onclick="changePhase('coding')">–ö–æ–¥</button>
                        <button class="finish-btn" onclick="finishInterview()">–ó–∞–≤–µ—Ä—à–∏—Ç—å</button>
                    </div>
                    
                    <div class="main-layout">
                        <div class="left-panel">
                            ${renderQuestionCard()}
                            ${renderChatCard()}
                        </div>
                        <div class="right-panel">
                            ${state.phase === 'coding' ? renderEditorCard() : renderTheoryAnswerCard()}
                        </div>
                    </div>
                </div>
            `;
        }
        
        function renderQuestionCard() {
            if (state.phase === 'theory' && state.currentTheory) {
                return `
                    <div class="card">
                        <div class="card-header">üìö –í–æ–ø—Ä–æ—Å ${state.theoryNum}/${state.theoryTotal}</div>
                        <div class="card-body">
                            <div class="task-meta"><span class="task-badge">${state.currentTheory.category}</span></div>
                            <p class="task-desc">${state.currentTheory.question}</p>
                        </div>
                    </div>
                `;
            }
            
            if (state.phase === 'coding' && state.currentTask) {
                const diffClass = state.currentTask.difficulty <= 3 ? 'low' : state.currentTask.difficulty <= 6 ? 'mid' : 'high';
                return `
                    <div class="card">
                        <div class="card-header">üíª ${state.currentTask.title}</div>
                        <div class="card-body">
                            <div class="task-meta">
                                <span class="task-badge difficulty-${diffClass}">–°–ª–æ–∂–Ω–æ—Å—Ç—å: ${state.currentTask.difficulty}/10</span>
                                <span class="task-badge">‚è±Ô∏è ${state.currentTask.time_limit} –º–∏–Ω</span>
                            </div>
                            <p class="task-desc">${state.currentTask.description}</p>
                            <div class="examples-box">
                                <div class="examples-label">–ü—Ä–∏–º–µ—Ä—ã:</div>
                                <pre class="examples-code">${state.currentTask.examples}</pre>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            return `
                <div class="card">
                    <div class="card-header">üëã –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å</div>
                    <div class="card-body">
                        <p class="task-desc">${state.phase === 'intro' ? '–ü–æ–∑–Ω–∞–∫–æ–º—å—Ç–µ—Å—å —Å –∏–Ω—Ç–µ—Ä–≤—å—é–µ—Ä–æ–º.' : ''}</p>
                    </div>
                </div>
            `;
        }
        
        function renderChatCard() {
            const activeRole = PHASE_AGENT_MAP[state.phase] || 'hr_manager';
            
            return `
                <div class="card chat-card">
                    <div class="card-header">üí¨ –ß–∞—Ç —Å –∏–Ω—Ç–µ—Ä–≤—å—é–µ—Ä–æ–º</div>
                    <div class="chat-messages" id="chatMessages">
                        ${state.messages.map(m => {
                            const isBot = m.type === 'bot';
                            const agentRole = m.agent?.role || 'hr_manager';
                            const aClass = agentRole === 'hr_manager' ? 'hr' : agentRole === 'tech_lead' ? 'tech' : 'dev';
                            const agentInfo = AGENT_NAMES[agentRole] || AGENT_NAMES.hr_manager;
                            return `
                                <div class="message ${isBot ? 'bot ' + aClass : 'user'}">
                                    <div class="msg-avatar">${isBot ? agentInfo.emoji : 'üë§'}</div>
                                    <div class="msg-content">
                                        ${isBot ? `<div class="msg-name">${agentInfo.name}</div>` : ''}
                                        ${m.text}
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                    <div class="chat-input-area">
                        <input type="text" class="chat-input" id="chatInput" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." onkeypress="if(event.key==='Enter')sendChat()">
                        <button class="chat-btn send" onclick="sendChat()">üì§</button>
                        <button class="chat-btn hint" onclick="getHint()">üí°</button>
                    </div>
                    <div class="agent-switcher">
                        <button class="agent-switch-btn hr ${activeRole === 'hr_manager' ? 'active' : ''}">üë©‚Äçüíº –ù–∞—Ç–∞–ª—å—è</button>
                        <button class="agent-switch-btn tech ${activeRole === 'tech_lead' ? 'active' : ''}">üë®‚Äçüíª –ò–≤–∞–Ω</button>
                        <button class="agent-switch-btn dev ${activeRole === 'senior_dev' ? 'active' : ''}">üßë‚Äçüíª –ê–ª–µ–∫—Å–µ–π</button>
                    </div>
                </div>
            `;
        }
        
        function renderEditorCard() {
            return `
                <div class="card editor-card">
                    <div class="editor-header">
                        <span class="editor-dots"><i></i><i></i><i></i></span>
                        <span class="editor-file">solution.py</span>
                        <button class="run-btn" onclick="submitCode()" ${state.loading ? 'disabled' : ''}>
                            ${state.loading ? '‚è≥' : '‚ñ∂'} –ó–∞–ø—É—Å—Ç–∏—Ç—å
                        </button>
                    </div>
                    <textarea class="code-editor" id="codeEditor" spellcheck="false">${state.codeValue}</textarea>
                    <div class="results-section">
                        <div class="results-header">–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–æ–≤</div>
                        <div class="results-list">
                            ${state.testResults.length === 0 ? 
                                '<div style="color:var(--text-secondary);text-align:center;padding:20px">–ó–∞–ø—É—Å—Ç–∏—Ç–µ –∫–æ–¥</div>' :
                                state.testResults.map(r => `
                                    <div class="test-result ${r.passed ? 'pass' : 'fail'}">
                                        <span>${r.passed ? '‚úÖ' : '‚ùå'}</span>
                                        <div style="flex:1">
                                            <div style="font-weight:500;color:${r.passed ? 'var(--accent-green)' : 'var(--accent-red)'}">
                                                –¢–µ—Å—Ç ${r.num} ${r.hidden ? '(—Å–∫—Ä—ã—Ç—ã–π)' : ''}
                                            </div>
                                            ${!r.hidden && !r.passed ? `<div style="font-size:0.8rem;color:var(--text-secondary);font-family:monospace;margin-top:4px">–û–∂–∏–¥–∞–ª–æ—Å—å: ${JSON.stringify(r.expected)} | –ü–æ–ª—É—á–µ–Ω–æ: ${JSON.stringify(r.actual)}</div>` : ''}
                                            ${r.error ? `<div style="color:var(--accent-red);font-size:0.8rem">${r.error}</div>` : ''}
                                        </div>
                                    </div>
                                `).join('')
                            }
                        </div>
                    </div>
                </div>
            `;
        }
        
        function renderTheoryAnswerCard() {
            if (state.phase !== 'theory') {
                return `<div class="card" style="display:flex;align-items:center;justify-content:center;min-height:400px">
                    <div style="text-align:center;color:var(--text-secondary)">
                        <div style="font-size:48px;margin-bottom:16px">üí¨</div>
                        <p>–û–±—â–∞–π—Ç–µ—Å—å —Å –∏–Ω—Ç–µ—Ä–≤—å—é–µ—Ä–æ–º –≤ —á–∞—Ç–µ</p>
                    </div>
                </div>`;
            }
            
            return `
                <div class="card" style="padding:20px">
                    <h3 style="margin-bottom:16px">–í–∞—à –æ—Ç–≤–µ—Ç</h3>
                    <textarea class="theory-answer" id="theoryAnswer" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à –æ—Ç–≤–µ—Ç...">${state.theoryAnswer}</textarea>
                    <button class="submit-theory-btn" onclick="submitTheory()" ${state.loading ? 'disabled' : ''}>
                        ${state.loading ? '‚è≥ –û—Ç–ø—Ä–∞–≤–∫–∞...' : 'üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç–≤–µ—Ç'}
                    </button>
                </div>
            `;
        }
        
        function renderReportScreen() {
            const report = state.report;
            if (!report) return '';
            
            const decisionClass = report.final_decision.includes('HIRE') && !report.final_decision.includes('NO') ? 'hire' : 
                                  report.final_decision.includes('MAYBE') ? 'maybe' : 'no-hire';
            
            return `
                <div class="report-screen">
                    <div class="report-card">
                        <div class="report-header">
                            <h2>üéØ –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∏–Ω—Ç–µ—Ä–≤—å—é</h2>
                            <p style="color:var(--text-secondary)">${state.level?.toUpperCase()} —É—Ä–æ–≤–µ–Ω—å</p>
                        </div>
                        
                        <div class="final-decision ${decisionClass}">${report.final_decision}</div>
                        
                        <div class="score-display">
                            <div class="score-big">${report.final_score}</div>
                            <div class="score-label">–∏—Ç–æ–≥–æ–≤—ã–π –±–∞–ª–ª</div>
                        </div>
                        
                        <div class="stats-grid">
                            <div class="stat-box"><div class="stat-value">${report.statistics?.coding_avg || 0}%</div><div class="stat-label">–ö–æ–¥</div></div>
                            <div class="stat-box"><div class="stat-value">${report.statistics?.theory_avg || 0}%</div><div class="stat-label">–¢–µ–æ—Ä–∏—è</div></div>
                            <div class="stat-box"><div class="stat-value">-${report.statistics?.total_penalties || 0}</div><div class="stat-label">–®—Ç—Ä–∞—Ñ—ã</div></div>
                        </div>
                        
                        <div class="agent-feedbacks">
                            <h3>üí¨ –û–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å –æ—Ç –∫–æ–º–∞–Ω–¥—ã</h3>
                            ${Object.entries(report.agent_feedback || {}).map(([role, feedback]) => {
                                const aClass = role.split('_')[0];
                                const agentInfo = AGENT_NAMES[role] || AGENT_NAMES.hr_manager;
                                const score = report.agent_scores?.[role] || 0;
                                return `
                                    <div class="feedback-item ${aClass}">
                                        <div class="feedback-header">
                                            <span class="feedback-name">${agentInfo.emoji} ${agentInfo.name}</span>
                                            <span class="feedback-score">${score}/100</span>
                                        </div>
                                        <p class="feedback-text">${feedback}</p>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                        
                        ${report.penalties?.length ? `
                            <div class="penalties-section">
                                <h3>‚ö†Ô∏è –®—Ç—Ä–∞—Ñ—ã (${report.penalties.length})</h3>
                                ${report.penalties.slice(0, 5).map(p => `<div class="penalty-item"><span>${p.reason}</span><span>-${p.points}</span></div>`).join('')}
                            </div>
                        ` : ''}
                        
                        <button class="restart-btn" onclick="restart()">üîÑ –ù–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ</button>
                    </div>
                </div>
            `;
        }
        
        // –ì–ª–æ–±–∞–ª—å–Ω–∞—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è CodeMirror
        let cmEditor = null;
        
        function setupEventListeners() {
            const chatMessages = document.getElementById('chatMessages');
            if (chatMessages) chatMessages.scrollTop = chatMessages.scrollHeight;
            
            const codeEditorTextarea = document.getElementById('codeEditor');
            if (codeEditorTextarea && !cmEditor) {
                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º CodeMirror
                cmEditor = CodeMirror.fromTextArea(codeEditorTextarea, {
                    mode: 'python',
                    theme: 'dracula',
                    lineNumbers: true,
                    indentUnit: 4,
                    tabSize: 4,
                    indentWithTabs: false,
                    lineWrapping: true,
                    matchBrackets: true,
                    autoCloseBrackets: true,
                    extraKeys: {
                        'Tab': (cm) => {
                            cm.replaceSelection('    ', 'end');
                        }
                    }
                });
                
                // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å–æ state
                cmEditor.setValue(state.codeValue || '');
                cmEditor.on('change', (cm) => {
                    state.codeValue = cm.getValue();
                });
                
                // –ê–Ω—Ç–∏—á–∏—Ç –¥–ª—è CodeMirror
                cmEditor.on('paste', (cm, e) => {
                    e.preventDefault();
                    antiCheat.reportViolation('paste_detected', '–ü–æ–ø—ã—Ç–∫–∞ –≤—Å—Ç–∞–≤–∫–∏ –≤ —Ä–µ–¥–∞–∫—Ç–æ—Ä –∫–æ–¥–∞');
                    antiCheat.showWarning('‚ö†Ô∏è –í—Å—Ç–∞–≤–∫–∞ –∑–∞–ø—Ä–µ—â–µ–Ω–∞', '–ö–æ–¥ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –ø–∏—Å–∞—Ç—å —Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ');
                });
                
                // –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Å–∫–æ—Ä–æ—Å—Ç–∏ –Ω–∞–±–æ—Ä–∞
                cmEditor.on('keypress', () => {
                    antiCheat.trackKeystroke('code-editor');
                });
            } else if (cmEditor) {
                // –û–±–Ω–æ–≤–ª—è–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –µ—Å–ª–∏ —Ä–µ–¥–∞–∫—Ç–æ—Ä —É–∂–µ –µ—Å—Ç—å
                if (cmEditor.getValue() !== state.codeValue) {
                    cmEditor.setValue(state.codeValue || '');
                }
            }
            
            const theoryAnswer = document.getElementById('theoryAnswer');
            if (theoryAnswer) {
                theoryAnswer.value = state.theoryAnswer;
                theoryAnswer.addEventListener('input', (e) => { state.theoryAnswer = e.target.value; });
            }
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è CodeMirror –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –Ω–æ–≤–æ–π –∑–∞–¥–∞—á–∏
        function updateCodeEditor(code) {
            state.codeValue = code;
            if (cmEditor) {
                cmEditor.setValue(code);
            }
        }
        
        render();
    </script>
</body>
</html>
